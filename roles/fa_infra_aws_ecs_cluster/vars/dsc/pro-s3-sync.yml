---
asg_desired_size: 3
asg_min_size: 3
instance_type: m4.large
sec_group_instance_rules:
  - proto: tcp
    from_port: 32768
    to_port: 60999
    cidr_ip: "{{ vpc_fact.vpcs.0.cidr_block }}"
    rule_desc: "Allow traffic to ECS dynamic port range from {{ channel }} VPC"

user_data: |
  #!/bin/bash

  echo "ECS_CLUSTER=cluster-{{ channel }}-{{ env }}-{{ deploy_in_subnet }}-{{ cluster_id }}" >> /etc/ecs/ecs.config
  echo "ECS_AVAILABLE_LOGGING_DRIVERS=[\"splunk\",\"syslog\",\"fluentd\",\"json-file\"]" >> /etc/ecs/ecs.config
  echo "ECS_ENABLE_CONTAINER_METADATA=true" >> /etc/ecs/ecs.config

  yum install -y amazon-efs-utils nfs-utils

  export AWS_DEFAULT_REGION="ap-southeast-2"
  export efs_sg_name=sec-{{ channel }}-{{ env }}-efs-s3-sync
  export efs_sg_id=$(aws ec2 describe-security-groups \
    --filters Name=tag:Name,Values=${efs_sg_name} \
    --query 'SecurityGroups[0].GroupId' \
    --output text)

  # Install rexray/efs driver as a docker plugin
  docker plugin install rexray/efs REXRAY_PREEMPT=true EFS_REGION=${AWS_DEFAULT_REGION} EFS_SECURITYGROUPS=${efs_sg_id}
  --grant-all-permissions

  # restart ecs agent
  stop ecs
  start ecs
